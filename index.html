<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Heuristic - Quan ly nhan su (Demo)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:16px;background:#f7f9fc;color:#222}
    h1{font-size:20px;margin-bottom:6px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:white;border:1px solid #e1e5ea;border-radius:6px;padding:12px;box-shadow:0 1px 3px rgba(0,0,0,0.04)}
    label{display:block;font-size:13px;margin-bottom:4px}
    input,select,button{padding:6px 8px;font-size:14px;border:1px solid #cbd5e1;border-radius:4px}
    table{border-collapse:collapse;width:100%;margin-top:8px}
    th,td{border:1px solid #e6eef6;padding:6px;text-align:center;font-size:13px}
    th{background:#f0f6ff}
    .small{font-size:12px;color:#555}
    .status-done{color:green;font-weight:600}
    .status-doing{color:orange;font-weight:600}
    .status-none{color:#c0392b;font-weight:600}
    #chart-wrap{max-width:780px;margin-top:12px}
    .controls{display:flex;gap:8px;align-items:end;flex-wrap:wrap}
    textarea{width:100%;height:90px;padding:8px;font-family:monospace}
    .col{flex:1;min-width:240px}
  </style>
</head>
<body>
  <h1>Ung dung: Ap dung Heuristic vao quan ly nhan su (quan an) — Demo</h1>

  <div class="row">
    <div class="card col">
      <strong>1) Nhap danh sach nhan vien (moi dong):</strong>
      <div class="small">Format: Ten;theluc(0-1);ky nang theo cong viec job1:score,job2:score,...</div>
      <textarea id="nhapNhanVien" placeholder="Vi du:\nAn;0.8;Phuc vu:0.9,Nau an:0.4,Thu ngan:0.6"></textarea>
      <button onclick="taiNhanVien()">Load nhan vien</button>
      <div id="soNhanVien" class="small"></div>
    </div>

    <div class="card col">
      <strong>2) Nhap danh sach cong viec (moi dong):</strong>
      <div class="small">Format: Ten cong viec;thoi gian(phut)</div>
      <textarea id="nhapCongViec" placeholder="Vi du:\nPhuc vu;10\nNau an;25"></textarea>
      <button onclick="taiCongViec()">Load cong viec</button>
      <div id="soCongViec" class="small"></div>
    </div>

    <div class="card" style="min-width:260px">
      <strong>3) Tham so Heuristic</strong>
      <div class="small">Diem(i,j) = x*(1/ThoiGian) + y*PhuHopKyNang + z*TheLuc</div>
      <div style="margin-top:8px">
        <label>Trong so x (thoi gian): <input id="trongSoX" type="number" step="0.05" value="0.5" /></label>
        <label>Trong so y (ky nang): <input id="trongSoY" type="number" step="0.05" value="0.3" /></label>
        <label>Trong so z (the luc): <input id="trongSoZ" type="number" step="0.05" value="0.2" /></label>
      </div>
      <div style="margin-top:8px">
        <label>Nguong ky nang bat buoc: <input id="nguongKyNang" type="number" step="0.05" value="0.5" /></label>
      </div>
      <div style="margin-top:6px">
        <button onclick="phanCongCảTuan()">Chay phan cong cho ca tuan (T2→T7)</button>
      </div>
      <div class="small" id="thongTinChay"></div>
    </div>
  </div>

  <div class="row" style="margin-top:12px">
    <div class="card col" style="min-width:420px">
      <strong>Ket qua phan cong</strong>
      <div id="bangPhanCong"></div>
    </div>

    <div class="card col" style="min-width:320px">
      <strong>Thong ke & hieu suat</strong>
      <div id="thongKe"></div>
    </div>
  </div>

  <div id="chart-wrap" class="card">
    <canvas id="bieuDoTuan"></canvas>
  </div>

<script>
/* ====== MO HINH DU LIEU ====== */
let NHAN_VIEN = []; // {ten,theluc, kyNang: {congViec:diem}}
let CONG_VIEC = []; // {ten, thoiGianMin}

/* ====== HAM GIUP DO ====== */
// Chuyen chuoi nhap thanh danh sach nhan vien
function phanTichNhanVien(text){
  const dong = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
  const arr = [];
  for(const ln of dong){
    const parts = ln.split(';').map(p=>p.trim());
    if(parts.length < 3) continue;
    const ten = parts[0];
    const theluc = Math.max(0, Math.min(1, parseFloat(parts[1]) || 0));
    const kyNang = {};
    parts[2].split(',').map(s=>s.trim()).filter(Boolean).forEach(pair=>{
      const kv = pair.split(':').map(x=>x.trim());
      if(kv.length==2) kyNang[kv[0]] = Math.max(0, Math.min(1, parseFloat(kv[1])||0));
    });
    arr.push({ten,theluc,kyNang});
  }
  return arr;
}

// Chuyen chuoi nhap thanh danh sach cong viec
function phanTichCongViec(text){
  const dong = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
  const arr = [];
  for(const ln of dong){
    const parts = ln.split(';').map(p=>p.trim());
    if(parts.length < 2) continue;
    const ten = parts[0];
    const tg = Math.max(1, parseFloat(parts[1]) || 1);
    arr.push({ten,thoiGianMin: tg});
  }
  return arr;
}

/* ====== HANH DONG UI ====== */
function taiNhanVien(){
  const raw = document.getElementById('nhapNhanVien').value;
  NHAN_VIEN = phanTichNhanVien(raw);
  document.getElementById('soNhanVien').innerText = "Da load " + NHAN_VIEN.length + " nhan vien";
  renderBangRong();
}
function taiCongViec(){
  const raw = document.getElementById('nhapCongViec').value;
  CONG_VIEC = phanTichCongViec(raw);
  document.getElementById('soCongViec').innerText = "Da load " + CONG_VIEC.length + " cong viec";
  renderBangRong();
}

/* ====== Heuristic ====== */
function tinhDiem(nv, congViec, params){
  const invTimes = CONG_VIEC.map(j=>1/j.thoiGianMin);
  const minInv = Math.min(...invTimes), maxInv = Math.max(...invTimes);
  let inv = 1/congViec.thoiGianMin;
  let invNorm = (maxInv - minInv) < 1e-9 ? 1 : (inv - minInv) / (maxInv - minInv);

  const phuHop = nv.kyNang[congViec.ten] !== undefined ? nv.kyNang[congViec.ten] : 0;
  const theluc = nv.theluc;

  let phuHopAdj = phuHop;
  if(phuHop < params.nguongKyNang) phuHopAdj *= 0.7;

  const score = params.x * invNorm + params.y * phuHopAdj + params.z * theluc;
  return {score, invNorm, phuHop, phuHopAdj, theluc};
}

/* ====== Phan cong trong ngay ====== */
function phanCongTrongNgay(){
  const params = {
    x: parseFloat(document.getElementById('trongSoX').value) || 0.5,
    y: parseFloat(document.getElementById('trongSoY').value) || 0.3,
    z: parseFloat(document.getElementById('trongSoZ').value) || 0.2,
    nguongKyNang: parseFloat(document.getElementById('nguongKyNang').value) || 0.5
  };
  const phanCong = [];
  const congViecSanCo = CONG_VIEC.slice();
  for(const cv of congViecSanCo){
    let totNhat = null;
    for(const nv of NHAN_VIEN){
      const r = tinhDiem(nv,cv,params);
      if(!totNhat || r.score > totNhat.score) totNhat = Object.assign({nv, cv}, r);
    }
    if(totNhat){
      const probHoanThanh = Math.min(0.95, 0.4 + 0.5 * totNhat.phuHop + 0.1 * totNhat.theluc);
      const rand = Math.random();
      let trangThai = (rand <= probHoanThanh) ? 'done' : (rand <= probHoanThanh + 0.15 ? 'doing' : 'none');
      phanCong.push({
        congViec: totNhat.cv.ten,
        nhanVien: totNhat.nv.ten,
        score: totNhat.score,
        phuHop: totNhat.phuHop,
        phuHopAdj: totNhat.phuHopAdj,
        theluc: totNhat.theluc,
        trangThai
      });
    }
  }
  return phanCong;
}

/* ====== Chay phan cong ca tuan ====== */
function phanCongCảTuan(){
  if(NHAN_VIEN.length===0 || CONG_VIEC.length===0){
    alert('Chua load du lieu nhan vien hoac cong viec.');
    return;
  }
  document.getElementById('thongTinChay').innerText = 'Dang chay...';
  const ngayTrongTuan = ['Thu 2','Thu 3','Thu 4','Thu 5','Thu 6','Thu 7'];
  const phanCongTuan = [];
  for(const n of ngayTrongTuan){
    phanCongTuan.push(phanCongTrongNgay());
  }

  const hieuSuatTheoNgay = phanCongTuan.map(pc=>{
    const hoanThanh = pc.filter(a=>a.trangThai==='done').length;
    return Math.round((hoanThanh/CONG_VIEC.length)*100);
  });

  const tongKetNhanVien = NHAN_VIEN.map(nv=>{
    let done=0,doing=0,none=0;
    phanCongTuan.forEach(pcNgay=>{
      const tasks = pcNgay.filter(a=>a.nhanVien===nv.ten);
      tasks.forEach(t=>{
        if(t.trangThai==='done') done++;
        else if(t.trangThai==='doing') doing++;
        else none++;
      });
    });
    const tongTask = done+doing+none;
    const hieuSuat = tongTask>0 ? Math.round((done/tongTask)*100) : 0;
    const trangThai = hieuSuat===100 ? 'Hoan thanh' : (hieuSuat>=50 ? 'Dang thuc hien' : 'Chua bat dau');
    return {ten:nv.ten,done,doing,none,tongTask,hieuSuat,trangThai};
  });

  renderBangPhanCong(phanCongTuan,ngayTrongTuan,hieuSuatTheoNgay,tongKetNhanVien);
  document.getElementById('thongTinChay').innerText = 'Hoan thanh.';
}

/* ====== RENDER ====== */
let bieuDoTuan = null;
function renderBangPhanCong(pcTuan,ngay,hieuSuat,tongKet){
  const wrap = document.getElementById('bangPhanCong');
  wrap.innerHTML = '';

  let html = '<div style="overflow:auto;">';
  for(let i=0;i<ngay.length;i++){
    html += `<div style="display:inline-block;vertical-align:top;margin-right:8px">
      <strong>${ngay[i]}</strong>
      <table><tr><th>Công việc</th><th>Nhân viên</th><th>Kỹ năng</th><th>Thể lực</th><th>Score</th><th>Trạng thái</th></tr>`;
    const assigns = pcTuan[i];
    for(const a of assigns){
      const cls = a.trangThai==='done' ? 'status-done' : (a.trangThai==='doing' ? 'status-doing' : 'status-none');
      html += `<tr>
        <td>${a.congViec}</td>
        <td>${a.nhanVien}</td>
        <td>${(a.phuHop*100).toFixed(0)}%</td>
        <td>${(a.theluc*100).toFixed(0)}%</td>
        <td>${(a.score*100).toFixed(1)}</td>
        <td class="${cls}">${a.trangThai==='done' ? 'Hoan thanh' : (a.trangThai==='doing' ? 'Dang lam' : 'Chua hoan thanh')}</td>
      </tr>`;
    }
    html += `</table></div>`;
  }
  html += '</div>';
  wrap.innerHTML = html;

  const sumWrap = document.getElementById('thongKe');
  let shtml = '<h4>Tom tat nhan vien (tuan)</h4>';
  shtml += '<table><tr><th>Nhan vien</th><th>Hoan thanh</th><th>Dang lam</th><th>Chua lam</th><th>Tong cong viec</th><th>Hieu suat</th><th>Trang thai</th></tr>';
  for(const e of tongKet){
    const cls = e.hieuSuat===100 ? 'status-done' : (e.hieuSuat>=50 ? 'status-doing' : 'status-none');
    shtml += `<tr><td>${e.ten}</td><td>${e.done}</td><td>${e.doing}</td><td>${e.none}</td><td>${e.tongTask}</td><td>${e.hieuSuat}%</td><td class="${cls}">${e.trangThai}</td></tr>`;
  }
  shtml += '</table>';
  sumWrap.innerHTML = shtml;

  const ctx = document.getElementById('bieuDoTuan').getContext('2d');
  if(bieuDoTuan) bieuDoTuan.destroy();
  bieuDoTuan = new Chart(ctx, {
    type: 'line',
    data: {
      labels: ngay,
      datasets: [{
        label: 'Hieu suat (%) - so job hoan thanh / tong job',
        data: hieuSuat,
        borderColor: '#1f77b4',
        backgroundColor: 'rgba(31,119,180,0.15)',
        fill: true,
        tension: 0.3,
        pointRadius:6
      }]
    },
    options: {
      responsive:true,
      scales:{ y: { min:0, max:100 } }
    }
  });
}

function renderBangRong(){
  document.getElementById('bangPhanCong').innerHTML = '<div class="small">Chua co ket qua. Nhap du lieu va chay phan cong.</div>';
  document.getElementById('thongKe').innerHTML = '';
}

/* ====== Du lieu mau ====== */
document.getElementById('nhapNhanVien').value =
`An;0.8;Phuc vu:0.9,Nau an:0.4,Thu ngan:0.6,Pha che:0.3
Binh;0.6;Phuc vu:0.5,Nau an:0.8,Thu ngan:0.7,Pha che:0.6
Chi;0.9;Phuc vu:0.7,Nau an:0.6,Thu ngan:0.9,Pha che:0.5`;
document.getElementById('nhapCongViec').value =
`Phuc vu;10
Nau an;25
Thu ngan;8
Pha che;12
Bo phan tu van;15`;

taiNhanVien();
taiCongViec();
renderBangRong();
</script>
</body>
</html>
